@page "/products"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>Products - CritterSupply</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Browse Products</MudText>

<MudGrid Class="mb-4">
    <MudItem xs="12" md="3">
        <MudSelect T="string" Label="Category" @bind-Value="_selectedCategory" Variant="Variant.Outlined">
            <MudSelectItem T="string" Value="@((string?)null)">All Categories</MudSelectItem>
            <MudSelectItem T="string" Value="@("Dogs")">Dogs</MudSelectItem>
            <MudSelectItem T="string" Value="@("Cats")">Cats</MudSelectItem>
            <MudSelectItem T="string" Value="@("Fish")">Fish</MudSelectItem>
            <MudSelectItem T="string" Value="@("Birds")">Birds</MudSelectItem>
        </MudSelect>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadProducts" FullWidth="true">
            Apply Filter
        </MudButton>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText Typo="Typo.body1" Class="mt-2">Loading products...</MudText>
}
else if (_productListing == null || !_productListing.Products.Any())
{
    <MudAlert Severity="Severity.Info" Class="mb-4">No products found. Try adjusting your filters.</MudAlert>
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@ClearFilters">
        Clear Filters
    </MudButton>
}
else
{
    <MudGrid>
        @foreach (var product in _productListing.Products)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard>
                    <MudCardMedia Image="@product.PrimaryImageUrl" Height="200" />
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@product.Name</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@product.Category</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-2">@product.Price.ToString("C")</MudText>
                        @if (!product.IsInStock)
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small" Class="mt-1">Out of Stock</MudChip>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.ShoppingCart"
                                   Disabled="@(!product.IsInStock)"
                                   OnClick="@(() => AddToCart(product.Sku, product.Price))"
                                   FullWidth="true">
                            Add to Cart
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (_productListing.TotalCount > _pageSize)
    {
        <MudPagination Class="mt-4"
                       Count="@((_productListing.TotalCount + _pageSize - 1) / _pageSize)"
                       Selected="_currentPage"
                       SelectedChanged="OnPageChanged"
                       Color="Color.Primary" />
    }
}

@code {
    private ProductListingView? _productListing;
    private bool _isLoading = true;
    private string? _selectedCategory = null;
    private int _currentPage = 1;
    private int _pageSize = 20;
    private Guid? _customerId;
    private Guid? _cartId;

    protected override async Task OnInitializedAsync()
    {
        // Get authenticated customer ID (optional - products page is public)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var customerIdClaim = authState.User.FindFirst("CustomerId")?.Value;
            if (Guid.TryParse(customerIdClaim, out var customerId))
            {
                _customerId = customerId;
                await InitializeCart();
            }
        }

        await LoadProducts();
    }

    private async Task InitializeCart()
    {
        if (!_customerId.HasValue) return;

        try
        {
            // Check if cart ID already exists in localStorage
            var existingCartId = await JS.InvokeAsync<string?>("authHelper.getCartId");
            if (!string.IsNullOrEmpty(existingCartId) && Guid.TryParse(existingCartId, out var cachedCartId))
            {
                _cartId = cachedCartId;
                Console.WriteLine($"Using existing cart: {_cartId}");
                return;
            }

            // Create a new cart for this customer via Shopping BC
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var response = await client.PostAsJsonAsync(
                "/api/storefront/carts/initialize",
                new { customerId = _customerId.Value });

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                // Response is the cartId GUID as a string
                if (Guid.TryParse(content.Trim('"'), out var cartId))
                {
                    _cartId = cartId;
                    // Store in localStorage for other pages
                    await JS.InvokeVoidAsync("authHelper.setCartId", cartId.ToString());
                    Console.WriteLine($"Cart initialized: {_cartId}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize cart: {ex.Message}");
            // Cart will be null - user can try again when adding items
        }
    }

    private async Task LoadProducts()
    {
        _isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var url = $"/api/storefront/products?page={_currentPage}&pageSize={_pageSize}";

            if (!string.IsNullOrEmpty(_selectedCategory))
            {
                url += $"&category={Uri.EscapeDataString(_selectedCategory)}";
            }

            _productListing = await client.GetFromJsonAsync<ProductListingView>(url);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load products: {ex.Message}");
            _productListing = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadProducts();
    }

    private async Task AddToCart(string sku, decimal unitPrice)
    {
        // Check if user is authenticated
        if (!_customerId.HasValue || !_cartId.HasValue)
        {
            Snackbar.Add("Please sign in to add items to cart", Severity.Warning);
            return;
        }

        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var response = await client.PostAsJsonAsync(
                $"/api/storefront/carts/{_cartId.Value}/items",
                new
                {
                    sku,
                    quantity = 1,
                    unitPrice
                });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Item added to cart!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to add item to cart: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding item to cart: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearFilters()
    {
        _selectedCategory = null;
        _currentPage = 1;
        await LoadProducts();
    }

    // View models matching BFF responses
    private sealed record ProductListingView(
        IReadOnlyList<ProductCardView> Products,
        int TotalCount,
        int Page,
        int PageSize);

    private sealed record ProductCardView(
        string Sku,
        string Name,
        decimal Price,
        string PrimaryImageUrl,
        string Category,
        bool IsInStock);

    private sealed record CartView(Guid CartId);
}
