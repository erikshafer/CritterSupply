@page "/products"
@rendermode InteractiveServer
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar

<PageTitle>Products - CritterSupply</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Browse Products</MudText>

<MudGrid Class="mb-4">
    <MudItem xs="12" md="3">
        <MudSelect T="string" Label="Category" @bind-Value="_selectedCategory" Variant="Variant.Outlined">
            <MudSelectItem T="string" Value="@((string?)null)">All Categories</MudSelectItem>
            <MudSelectItem T="string" Value="@("Dogs")">Dogs</MudSelectItem>
            <MudSelectItem T="string" Value="@("Cats")">Cats</MudSelectItem>
            <MudSelectItem T="string" Value="@("Fish")">Fish</MudSelectItem>
            <MudSelectItem T="string" Value="@("Birds")">Birds</MudSelectItem>
        </MudSelect>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadProducts" FullWidth="true">
            Apply Filter
        </MudButton>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText Typo="Typo.body1" Class="mt-2">Loading products...</MudText>
}
else if (_productListing == null || !_productListing.Products.Any())
{
    <MudAlert Severity="Severity.Info" Class="mb-4">No products found. Try adjusting your filters.</MudAlert>
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@ClearFilters">
        Clear Filters
    </MudButton>
}
else
{
    <MudGrid>
        @foreach (var product in _productListing.Products)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard>
                    <MudCardMedia Image="@product.PrimaryImageUrl" Height="200" />
                    <MudCardContent>
                        <MudText Typo="Typo.h6">@product.Name</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@product.Category</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-2">@product.Price.ToString("C")</MudText>
                        @if (!product.IsInStock)
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small" Class="mt-1">Out of Stock</MudChip>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.ShoppingCart"
                                   Disabled="@(!product.IsInStock)"
                                   OnClick="@(() => AddToCart(product.Sku, product.Price))"
                                   FullWidth="true">
                            Add to Cart
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (_productListing.TotalCount > _pageSize)
    {
        <MudPagination Class="mt-4"
                       Count="@((_productListing.TotalCount + _pageSize - 1) / _pageSize)"
                       Selected="_currentPage"
                       SelectedChanged="OnPageChanged"
                       Color="Color.Primary" />
    }
}

@code {
    private ProductListingView? _productListing;
    private bool _isLoading = true;
    private string? _selectedCategory = null;
    private int _currentPage = 1;
    private int _pageSize = 20;

    // Stub customer ID and cart ID - in real app this would come from authentication
    private readonly Guid _customerId = Guid.Parse("11111111-1111-1111-1111-111111111111");
    private readonly Guid _cartId = Guid.Parse("22222222-2222-2222-2222-222222222222");

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var url = $"/api/storefront/products?page={_currentPage}&pageSize={_pageSize}";

            if (!string.IsNullOrEmpty(_selectedCategory))
            {
                url += $"&category={Uri.EscapeDataString(_selectedCategory)}";
            }

            _productListing = await client.GetFromJsonAsync<ProductListingView>(url);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load products: {ex.Message}");
            _productListing = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadProducts();
    }

    private async Task AddToCart(string sku, decimal unitPrice)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var response = await client.PostAsJsonAsync(
                $"/api/storefront/carts/{_cartId}/items",
                new
                {
                    sku,
                    quantity = 1,
                    unitPrice
                });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Item added to cart!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to add item to cart: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding item to cart: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearFilters()
    {
        _selectedCategory = null;
        _currentPage = 1;
        await LoadProducts();
    }

    // View models matching BFF responses
    private sealed record ProductListingView(
        IReadOnlyList<ProductCardView> Products,
        int TotalCount,
        int Page,
        int PageSize);

    private sealed record ProductCardView(
        string Sku,
        string Name,
        decimal Price,
        string PrimaryImageUrl,
        string Category,
        bool IsInStock);
}
