@page "/cart"
@attribute [Authorize]
@rendermode InteractiveServer
@using System.Text.Json
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IAsyncDisposable

<PageTitle>Shopping Cart - CritterSupply</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Shopping Cart</MudText>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText Typo="Typo.body1" Class="mt-2">Loading your cart...</MudText>
}
else if (_cartView == null || !_cartView.Items.Any())
{
    <MudAlert Severity="Severity.Info">Your cart is empty.</MudAlert>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/products" Class="mt-4">
        Browse Products
    </MudButton>
}
else
{
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4">
                @foreach (var item in _cartView.Items)
                {
                    <MudCard Class="mb-3">
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="3">
                                    <MudImage Src="@item.ProductImageUrl" Alt="@item.ProductName" Height="100" ObjectFit="ObjectFit.Cover" />
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.h6">@item.ProductName</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">SKU: @item.Sku</MudText>
                                    <MudText Typo="Typo.body1" Class="mt-2">@item.UnitPrice.ToString("C")</MudText>
                                </MudItem>
                                <MudItem xs="3" Class="d-flex flex-column align-end">
                                    <div class="d-flex align-center mb-2">
                                        <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                       Size="Size.Small"
                                                       OnClick="@(() => DecreaseQuantity(item.Sku, item.Quantity))"
                                                       Disabled="@(item.Quantity <= 1 || _isProcessing)" />
                                        <MudText Typo="Typo.body1" Class="mx-2">@item.Quantity</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                       Size="Size.Small"
                                                       OnClick="@(() => IncreaseQuantity(item.Sku, item.Quantity))"
                                                       Disabled="@_isProcessing" />
                                    </div>
                                    <MudText Typo="Typo.h6" Class="mb-2">@item.LineTotal.ToString("C")</MudText>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               OnClick="@(() => RemoveItem(item.Sku))"
                                               Disabled="@_isProcessing">
                                        Remove
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h5" Class="mb-4">Order Summary</MudText>
                <MudDivider Class="mb-3" />
                <div class="d-flex justify-space-between mb-2">
                    <MudText Typo="Typo.body1">Subtotal</MudText>
                    <MudText Typo="Typo.body1">@_cartView.Subtotal.ToString("C")</MudText>
                </div>
                <MudDivider Class="my-3" />
                <div class="d-flex justify-space-between mb-4">
                    <MudText Typo="Typo.h6">Total</MudText>
                    <MudText Typo="Typo.h6">@_cartView.Subtotal.ToString("C")</MudText>
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Href="/checkout">
                    Proceed to Checkout
                </MudButton>
            </MudPaper>

            @if (_sseConnected)
            {
                <MudChip T="string" Icon="@Icons.Material.Filled.Wifi" Color="Color.Success" Size="Size.Small" Class="mt-2">
                    Real-time updates active
                </MudChip>
            }
        </MudItem>
    </MudGrid>
}

@code {
    private CartView? _cartView;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private bool _sseConnected = false;
    private DotNetObjectReference<Cart>? _dotNetHelper;
    private Guid _customerId;
    private readonly Guid _cartId = Guid.Parse("019c5dd6-29d2-7fb9-9d90-cf760997d1c0");

    protected override async Task OnInitializedAsync()
    {
        // Get authenticated customer ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var customerIdClaim = authState.User.FindFirst("CustomerId")?.Value;
        if (!Guid.TryParse(customerIdClaim, out _customerId))
        {
            // Should not happen due to [Authorize] but handle gracefully
            return;
        }

        await LoadCart();
        await SubscribeToSSE();
    }

    private async Task LoadCart()
    {
        _isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            _cartView = await client.GetFromJsonAsync<CartView>($"/api/storefront/carts/{_cartId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load cart: {ex.Message}");
            _cartView = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SubscribeToSSE()
    {
        try
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("sseClient.subscribe", _customerId.ToString(), _dotNetHelper);
            _sseConnected = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to subscribe to SSE: {ex.Message}");
            _sseConnected = false;
        }
    }

    [JSInvokable]
    public async Task OnSseEvent(JsonElement eventData)
    {
        Console.WriteLine($"SSE event received: {eventData}");

        // Parse event type
        if (eventData.TryGetProperty("eventType", out var eventType))
        {
            var eventTypeName = eventType.GetString();

            if (eventTypeName == "cart-updated")
            {
                // Reload cart data from BFF
                await LoadCart();
                StateHasChanged();
            }
            // TODO (Cycle 19): Add handlers for "item-quantity-changed" and "item-removed" SSE events
            // Currently only "cart-updated" (from AddItem) triggers real-time refresh
            // User must manually refresh page after clicking +/- quantity buttons
        }
    }

    private async Task RemoveItem(string sku)
    {
        _isProcessing = true;
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var response = await client.DeleteAsync($"/api/storefront/carts/{_cartId}/items/{sku}");

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Item removed from cart", Severity.Success);
                // SSE will trigger cart reload automatically
            }
            else
            {
                Snackbar.Add($"Failed to remove item: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing item: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task IncreaseQuantity(string sku, int currentQuantity)
    {
        await ChangeQuantity(sku, currentQuantity + 1);
    }

    private async Task DecreaseQuantity(string sku, int currentQuantity)
    {
        if (currentQuantity > 1)
        {
            await ChangeQuantity(sku, currentQuantity - 1);
        }
    }

    private async Task ChangeQuantity(string sku, int newQuantity)
    {
        _isProcessing = true;
        try
        {
            var client = HttpClientFactory.CreateClient("StorefrontApi");
            var response = await client.PutAsJsonAsync(
                $"/api/storefront/carts/{_cartId}/items/{sku}/quantity",
                new { newQuantity });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Quantity updated", Severity.Success);
                // SSE will trigger cart reload automatically
            }
            else
            {
                Snackbar.Add($"Failed to update quantity: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating quantity: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("sseClient.unsubscribe");
            _dotNetHelper?.Dispose();
        }
        catch
        {
            // Ignore disposal errors
        }
    }

    // View model matching BFF CartView
    private sealed record CartView(
        Guid CartId,
        Guid CustomerId,
        IReadOnlyList<CartLineItemView> Items,
        decimal Subtotal);

    private sealed record CartLineItemView(
        string Sku,
        string ProductName,
        string ProductImageUrl,
        int Quantity,
        decimal UnitPrice,
        decimal LineTotal);
}
