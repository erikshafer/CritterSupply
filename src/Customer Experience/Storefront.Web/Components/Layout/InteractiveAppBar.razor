@using System.Text.Json
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IAsyncDisposable

<MudAppBar Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
    <MudText Typo="Typo.h6">CritterSupply</MudText>
    <MudSpacer />
    <MudBadge Content="@_cartItemCount" Color="Color.Secondary" Overlap="true" Visible="@(_cartItemCount > 0)">
        <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" Href="/cart" />
    </MudBadge>

    <AuthorizeView>
        <Authorized>
            <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <MudText Typo="Typo.body2" Class="px-4 py-2">@context.User.FindFirst(ClaimTypes.GivenName)?.Value</MudText>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/account">My Account</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Receipt" Href="/orders">Order History</MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout">Logout</MudMenuItem>
            </MudMenu>
        </Authorized>
        <NotAuthorized>
            <MudButton Variant="Variant.Text" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Login" Href="/login">
                Sign In
            </MudButton>
        </NotAuthorized>
    </AuthorizeView>
</MudAppBar>

<MudDrawer @bind-Open="@DrawerOpen" Elevation="2">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6">Navigation</MudText>
    </MudDrawerHeader>
    <MudNavMenu>
        <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
        <MudNavLink Href="/cart" Icon="@Icons.Material.Filled.ShoppingCart">Cart</MudNavLink>
        <MudNavLink Href="/checkout" Icon="@Icons.Material.Filled.Payment">Checkout</MudNavLink>
        <MudNavLink Href="/orders" Icon="@Icons.Material.Filled.Receipt">Order History</MudNavLink>
    </MudNavMenu>
</MudDrawer>

@code {
    [Parameter]
    public bool DrawerOpen { get; set; } = true;

    [Parameter]
    public EventCallback<bool> DrawerOpenChanged { get; set; }

    private int _cartItemCount = 0;
    private DotNetObjectReference<InteractiveAppBar>? _dotNetHelper;
    private Guid? _customerId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get authenticated customer ID
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var customerIdClaim = authState.User.FindFirst("CustomerId")?.Value;
            if (Guid.TryParse(customerIdClaim, out var customerId))
            {
                _customerId = customerId;
                await SubscribeToSSE();
            }
        }
    }

    private async Task SubscribeToSSE()
    {
        if (!_customerId.HasValue) return;

        try
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("sseClient.subscribe", _customerId.Value.ToString(), _dotNetHelper);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to subscribe to SSE in AppBar: {ex.Message}");
        }
    }

    private async Task HandleLogout()
    {
        try
        {
            // Use JavaScript fetch via browser to call server-side logout endpoint
            // This ensures the browser properly clears the authentication cookie
            var success = await JS.InvokeAsync<bool>("authHelper.logout");

            if (success)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Console.WriteLine("Logout failed");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout failed: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnSseEvent(JsonElement eventData)
    {
        // Parse event type
        if (eventData.TryGetProperty("eventType", out var eventType))
        {
            var eventTypeName = eventType.GetString();

            if (eventTypeName == "cart-updated")
            {
                // Extract itemCount from event data
                if (eventData.TryGetProperty("itemCount", out var itemCount))
                {
                    _cartItemCount = itemCount.GetInt32();
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
    }

    private async Task ToggleDrawer()
    {
        DrawerOpen = !DrawerOpen;
        await DrawerOpenChanged.InvokeAsync(DrawerOpen);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("sseClient.unsubscribe");
            _dotNetHelper?.Dispose();
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
